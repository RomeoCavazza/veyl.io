name: CI/CD Pipeline

# Testing Railway deployment with new Project Token

permissions:
  contents: read
  deployments: write
  actions: read

on:
  push:
    branches: [main]
    # Only deploy on main branch, and only if source code changes
    # Using paths (not paths-ignore) to explicitly include only relevant files
    paths:
      - 'apps/frontend/**'
      - 'apps/backend/**'
      - '.github/workflows/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'start.sh'
  pull_request:
    branches: [main]
    paths:
      - 'apps/frontend/**'
      - 'apps/backend/**'
  # Allow manual deployment via workflow_dispatch
  workflow_dispatch:

jobs:
  # Nettoyer TOUS les anciens dÃ©ploiements avant de crÃ©er les nouveaux
  cleanup-deployments:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Cleanup all old deployments
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              console.log('ðŸ§¹ Nettoyage de tous les anciens dÃ©ploiements...');
              
              // RÃ©cupÃ©rer TOUS les dÃ©ploiements (tous environnements)
              const allDeployments = await github.rest.repos.listDeployments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              
              console.log(`ðŸ“¦ ${allDeployments.data.length} dÃ©ploiement(s) trouvÃ©(s) au total`);
              
              // Supprimer TOUS les anciens dÃ©ploiements avant de crÃ©er les nouveaux
              // On va crÃ©er 2 nouveaux dÃ©ploiements (1 Production + 1 Railway), donc on supprime tout
              console.log(`ðŸ—‘ï¸  Suppression de TOUS les ${allDeployments.data.length} ancien(s) dÃ©ploiement(s) avant de crÃ©er les nouveaux`);
              
              for (const deployment of allDeployments.data) {
                try {
                  // Marquer comme inactive avant de supprimer
                  await github.rest.repos.createDeploymentStatus({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    deployment_id: deployment.id,
                    state: 'inactive'
                  });
                  await github.rest.repos.deleteDeployment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    deployment_id: deployment.id
                  });
                  console.log(`ðŸ—‘ï¸  DÃ©ploiement #${deployment.id} (${deployment.environment}) supprimÃ©`);
                } catch (error) {
                  console.log(`âš ï¸  Erreur lors de la suppression du dÃ©ploiement #${deployment.id}: ${error.message}`);
                }
              }
              
              console.log('âœ… Tous les anciens dÃ©ploiements supprimÃ©s - les nouveaux seront crÃ©Ã©s par les jobs frontend/backend');
              
              console.log('âœ… Nettoyage terminÃ©');
            } catch (error) {
              console.error('âŒ Erreur lors du nettoyage:', error.message);
              // Ne pas faire Ã©chouer le workflow si le nettoyage Ã©choue
            }

  # Check if deployment is needed
  check-changes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            frontend:
              - 'apps/frontend/**'
            backend:
              - 'apps/backend/**'
              - 'start.sh'
              - 'Dockerfile'
              - 'requirements.txt'

  frontend:
    runs-on: ubuntu-latest
    needs: [check-changes, cleanup-deployments]
    if: always() && github.ref == 'refs/heads/main'
    outputs:
      vercel-deploy-outcome: ${{ steps.vercel-deploy.outcome }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        working-directory: ./apps/frontend
        run: pnpm install --frozen-lockfile
        
      - name: Type check
        working-directory: ./apps/frontend
        run: pnpm type-check
        
      - name: Build
        working-directory: ./apps/frontend
        run: pnpm build
        id: build
        
      - name: Deploy to Vercel (production only)
        if: github.ref == 'refs/heads/main'
        id: vercel-deploy
        run: |
          echo "ðŸ“¦ Current directory: $(pwd)"
          echo "ðŸ“¦ Listing apps/frontend:"
          ls -la apps/frontend/ | head -20
          echo "ðŸ“¦ Checking if dist folder exists:"
          ls -la apps/frontend/dist/ 2>/dev/null || echo "âš ï¸ dist folder not found!"
          echo "ðŸ“¦ Deploying to Vercel..."
          npx -y vercel@latest --prod --token ${{ secrets.VERCEL_TOKEN }} --yes
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      
      - name: Create GitHub Deployment (Vercel)
        if: github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              // VÃ©rifier si le dÃ©ploiement Vercel a rÃ©ussi
              const vercelOutcome = '${{ steps.vercel-deploy.outcome }}';
              const vercelSuccess = vercelOutcome === 'success';
              const deployState = vercelSuccess ? 'success' : (vercelOutcome === 'failure' ? 'failure' : 'pending');
              
              console.log(`ðŸ” Ã‰tat du dÃ©ploiement Vercel: ${vercelOutcome || 'not executed'}`);
              console.log(`ðŸ“¦ CrÃ©ation du GitHub Deployment avec statut: ${deployState}`);
              
              // Le nettoyage a dÃ©jÃ  Ã©tÃ© fait par le job cleanup-deployments
              // CrÃ©er directement le nouveau dÃ©ploiement
              console.log('âœ¨ CrÃ©ation du nouveau dÃ©ploiement Vercel...');
              const newDeployment = await github.rest.repos.createDeployment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.sha,
                environment: 'Vercel',
                auto_merge: false,
                required_contexts: [],
                description: `Deployed via GitHub Actions - ${context.sha.substring(0, 7)}`
              });
              
              console.log(`âœ… DÃ©ploiement #${newDeployment.data.id} crÃ©Ã© avec succÃ¨s`);
              
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: newDeployment.data.id,
                state: deployState,
                environment_url: 'https://www.veyl.io',
                description: vercelSuccess ? 'Deployment successful' : (vercelOutcome === 'failure' ? 'Deployment failed' : 'Deployment in progress')
              });
              
              console.log(`ðŸŽ‰ Statut de dÃ©ploiement mis Ã  jour: ${deployState}`);
            } catch (error) {
              console.error('âŒ Erreur lors de la crÃ©ation du GitHub Deployment:', error);
              console.error('DÃ©tails:', JSON.stringify(error, null, 2));
              throw error;
            }

  backend:
    runs-on: ubuntu-latest
    needs: [check-changes, cleanup-deployments]
    if: always() && github.ref == 'refs/heads/main'
    outputs:
      railway-deploy-outcome: ${{ steps.railway-deploy.outcome }}
    defaults:
      run:
        working-directory: ./apps/backend
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: pip install -r requirements.txt
        
      - name: Run tests (if available)
        continue-on-error: true
        run: |
          if [ -f "test_*.py" ] || [ -d "tests" ]; then
            python -m pytest || echo "Tests failed, continuing..."
          else
            echo "No tests found, skipping..."
          fi
          
      - name: Deploy to Railway (production only)
        if: github.ref == 'refs/heads/main'
        id: railway-deploy
        continue-on-error: true
        run: |
          # Railway CLI utilise RAILWAY_TOKEN depuis la variable d'environnement
          echo "ðŸ“¦ Current directory: $(pwd)"
          echo "ðŸ“¦ Deploying to Railway..."
          # Railway.toml est Ã  la racine, donc on dÃ©ploie depuis la racine
          cd ${{ github.workspace }}
          echo "ðŸ“¦ Working directory: $(pwd)"
          echo "ðŸ“¦ Checking railway.toml:"
          cat railway.toml || echo "âš ï¸ railway.toml not found"
          # Utiliser railway up sans --path-as-root car railway.toml dÃ©finit dÃ©jÃ  le buildPath
          npx -y @railway/cli@latest up --service veyl.io --detach && {
            echo "âœ… DÃ©ploiement rÃ©ussi avec service 'veyl.io'"
            exit 0
          }
          echo "âŒ Railway CLI failed. Check if RAILWAY_TOKEN is un Project Token valide."
          exit 1
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      
      - name: Create GitHub Deployment (Railway)
        if: github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const envName = 'Railway';
              const railwayOutcome = '${{ steps.railway-deploy.outcome }}';
              const railwaySuccess = railwayOutcome === 'success';
              const deployState = railwaySuccess ? 'success' : (railwayOutcome === 'failure' ? 'failure' : 'pending');
              
              console.log(`ðŸ” Ã‰tat du dÃ©ploiement Railway: ${railwayOutcome || 'not executed'}`);
              console.log(`ðŸ“¦ CrÃ©ation du GitHub Deployment avec statut: ${deployState}`);
              
              // Le nettoyage a dÃ©jÃ  Ã©tÃ© fait par le job cleanup-deployments
              // CrÃ©er directement le nouveau dÃ©ploiement
              console.log(`âœ¨ CrÃ©ation du nouveau dÃ©ploiement Railway...`);
              const newDeployment = await github.rest.repos.createDeployment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.sha,
                environment: envName,
                auto_merge: false,
                required_contexts: [],
                description: `Deployed via GitHub Actions - ${context.sha.substring(0, 7)}`
              });
              
              console.log(`âœ… DÃ©ploiement #${newDeployment.data.id} crÃ©Ã© avec succÃ¨s`);
              
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: newDeployment.data.id,
                state: deployState,
                environment_url: 'https://api.veyl.io',
                description: railwaySuccess ? 'Deployment successful' : (railwayOutcome === 'failure' ? 'Deployment failed' : 'Deployment in progress')
              });
              
              console.log(`ðŸŽ‰ Statut de dÃ©ploiement mis Ã  jour: ${deployState}`);
            } catch (error) {
              console.error('âŒ Erreur lors de la crÃ©ation du GitHub Deployment:', error);
              console.error('DÃ©tails:', JSON.stringify(error, null, 2));
              throw error;
            }

  # Job final : s'assurer que les 2 dÃ©ploiements existent toujours
  # CrÃ©e les dÃ©ploiements manquants si les jobs frontend/backend ont Ã©tÃ© skippÃ©s
  ensure-deployments:
    runs-on: ubuntu-latest
    needs: [check-changes, cleanup-deployments, frontend, backend]
    if: always() && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Ensure both deployments exist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              console.log('ðŸ” VÃ©rification finale - s\'assurer qu\'il y a exactement 2 dÃ©ploiements...');
              
              // RÃ©cupÃ©rer TOUS les dÃ©ploiements
              const allDeployments = await github.rest.repos.listDeployments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              
              const frontendEnv = 'Vercel';
              const backendEnv = 'Railway';
              
              // SÃ©parer par environnement
              const frontendDeployments = allDeployments.data.filter(d => d.environment === frontendEnv)
                .sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());
              const backendDeployments = allDeployments.data.filter(d => d.environment === backendEnv)
                .sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());
              
              console.log(`ðŸ“¦ DÃ©ploiements trouvÃ©s: ${frontendDeployments.length} Vercel, ${backendDeployments.length} Railway`);
              
              // Garder seulement le plus rÃ©cent de chaque environnement, supprimer les autres
              const toKeep = new Set();
              if (frontendDeployments.length > 0) {
                toKeep.add(frontendDeployments[0].id);
                // Supprimer les doublons Frontend
                for (let i = 1; i < frontendDeployments.length; i++) {
                  try {
                    await github.rest.repos.createDeploymentStatus({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      deployment_id: frontendDeployments[i].id,
                      state: 'inactive'
                    });
                    await github.rest.repos.deleteDeployment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      deployment_id: frontendDeployments[i].id
                    });
                    console.log(`ðŸ—‘ï¸  DÃ©ploiement Vercel #${frontendDeployments[i].id} (doublon) supprimÃ©`);
                  } catch (error) {
                    console.log(`âš ï¸  Erreur suppression doublon Vercel #${frontendDeployments[i].id}: ${error.message}`);
                  }
                }
              }
              
              if (backendDeployments.length > 0) {
                toKeep.add(backendDeployments[0].id);
                // Supprimer les doublons Backend
                for (let i = 1; i < backendDeployments.length; i++) {
                  try {
                    await github.rest.repos.createDeploymentStatus({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      deployment_id: backendDeployments[i].id,
                      state: 'inactive'
                    });
                    await github.rest.repos.deleteDeployment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      deployment_id: backendDeployments[i].id
                    });
                    console.log(`ðŸ—‘ï¸  DÃ©ploiement Railway #${backendDeployments[i].id} (doublon) supprimÃ©`);
                  } catch (error) {
                    console.log(`âš ï¸  Erreur suppression doublon Railway #${backendDeployments[i].id}: ${error.message}`);
                  }
                }
              }
              
              // CrÃ©er les dÃ©ploiements manquants seulement s'ils n'existent pas
              if (frontendDeployments.length === 0) {
                console.log('ðŸ“¦ CrÃ©ation du dÃ©ploiement Vercel manquant...');
                const frontendDeployment = await github.rest.repos.createDeployment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: context.sha,
                  environment: frontendEnv,
                  auto_merge: false,
                  required_contexts: [],
                  description: `Deployed via GitHub Actions - ${context.sha.substring(0, 7)} (no frontend changes)`
                });
                
                await github.rest.repos.createDeploymentStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: frontendDeployment.data.id,
                  state: 'success',
                  environment_url: 'https://www.veyl.io',
                  description: 'No frontend changes in this commit'
                });
                console.log('âœ… DÃ©ploiement Vercel crÃ©Ã©');
              }
              
              if (backendDeployments.length === 0) {
                console.log('ðŸ“¦ CrÃ©ation du dÃ©ploiement Railway manquant...');
                const backendDeployment = await github.rest.repos.createDeployment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: context.sha,
                  environment: backendEnv,
                  auto_merge: false,
                  required_contexts: [],
                  description: `Deployed via GitHub Actions - ${context.sha.substring(0, 7)} (no backend changes)`
                });
                
                await github.rest.repos.createDeploymentStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: backendDeployment.data.id,
                  state: 'success',
                  environment_url: 'https://api.veyl.io',
                  description: 'No backend changes in this commit'
                });
                console.log('âœ… DÃ©ploiement Railway crÃ©Ã©');
              }
              
              console.log('ðŸŽ‰ VÃ©rification terminÃ©e - exactement 2 dÃ©ploiements garantis (1 Vercel + 1 Railway)');
            } catch (error) {
              console.error('âŒ Erreur lors de la vÃ©rification:', error.message);
              // Ne pas faire Ã©chouer le workflow
            }
