name: CI/CD Pipeline

on:
  push:
    branches: [main]
    # Only deploy on main branch, and only if source code changes
    # Using paths (not paths-ignore) to explicitly include only relevant files
    paths:
      - 'apps/frontend/**'
      - 'apps/backend/**'
      - '.github/workflows/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'start.sh'
  pull_request:
    branches: [main]
    paths:
      - 'apps/frontend/**'
      - 'apps/backend/**'
  # Allow manual deployment via workflow_dispatch
  workflow_dispatch:

jobs:
  # Check if deployment is needed
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            frontend:
              - 'apps/frontend/**'
            backend:
              - 'apps/backend/**'
              - 'start.sh'
              - 'Dockerfile'
              - 'requirements.txt'

  frontend:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
    defaults:
      run:
        working-directory: ./apps/frontend
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Type check
        run: pnpm type-check
        
      - name: Build
        run: pnpm build
        
      - name: Deploy to Vercel (production only)
        if: github.ref == 'refs/heads/main'
        working-directory: ./apps/frontend
        id: vercel-deploy
        run: |
          npx vercel@latest --prod --token ${{ secrets.VERCEL_TOKEN }} --yes
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      
      - name: Create GitHub Deployment (Vercel)
        if: github.ref == 'refs/heads/main' && steps.vercel-deploy.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            // Supprimer les anciens déploiements Production pour garder seulement le dernier
            const deployments = await github.rest.repos.listDeployments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              environment: 'Production',
              per_page: 100
            });
            
            // Supprimer tous les anciens déploiements (on garde seulement le nouveau)
            for (const deployment of deployments.data) {
              await github.rest.repos.deleteDeployment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.id
              });
            }
            
            // Créer le nouveau déploiement (le seul visible)
            const newDeployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'Production',
              auto_merge: false,
              required_contexts: []
            });
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: newDeployment.data.id,
              state: 'success',
              environment_url: 'https://www.veyl.io'
            });

  backend:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
    defaults:
      run:
        working-directory: ./apps/backend
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: pip install -r requirements.txt
        
      - name: Run tests (if available)
        run: |
          if [ -f "test_*.py" ]; then
            python -m pytest
          else
            echo "No tests found, skipping..."
          fi
          
      - name: Deploy to Railway (production only)
        if: github.ref == 'refs/heads/main'
        id: railway-deploy
        uses: bervProject/railway-deploy@v1.0.6
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: insidr-production
      
      - name: Create GitHub Deployment (Railway)
        if: github.ref == 'refs/heads/main' && steps.railway-deploy.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const envName = 'insidr (satisfied-mindfulness / production)';
            
            // Supprimer les anciens déploiements Railway pour garder seulement le dernier
            const deployments = await github.rest.repos.listDeployments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              environment: envName,
              per_page: 100
            });
            
            // Supprimer tous les anciens déploiements (on garde seulement le nouveau)
            for (const deployment of deployments.data) {
              await github.rest.repos.deleteDeployment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.id
              });
            }
            
            // Créer le nouveau déploiement (le seul visible)
            const newDeployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: envName,
              auto_merge: false,
              required_contexts: []
            });
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: newDeployment.data.id,
              state: 'success',
              environment_url: 'https://insidr-production.up.railway.app'
            });
